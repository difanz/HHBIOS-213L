;	INT8.INC
;	1994.4.27, 7.22, 11.29
;	1995.1.24, 3.17, 3.25
;	1996.3.26

D_NUM1		DB	0

S_GBSS		PROC	NEAR
K_GBSS: 	NOP
		NOT	CS:D_NUM1
		CMP	CS:D_NUM1,0
		JZ	L_SS1
		JMP	S_QGB
L_SS1:		JMP	S_XGB
S_GBSS		ENDP

D_8		DB	2			;INT8忙标志

INT_8		PROC	FAR
		PUSHF
		CALL	CS:D_INT8		;原INT8
		STI				;1.24
		CLD
		TEST	CS:D_8,80H		;判忙?
K_INT8	EQU	$
		JNZ	L_8001
		DEC	CS:D_8
		TEST	CS:D_8,7
		JNZ	L_8001
		CALL	S_0800			;执行INT8
L_8001:
		IRET
INT_8		ENDP

;子程序:执行INT8
S_0800		PROC	NEAR
		PUSH	DS
		PUSH	ES
		PUSH	AX
		PUSH	BX
		PUSH	CX
		PUSH	DX
		PUSH	SI
		PUSH	DI
		PUSH	BP
		MOV	AL,20H
		OUT	20H,AL
		MOV	AL,CS:D_ZJXP		;3.16
		OR	AL,80H
		MOV	CS:D_8,AL
		PUSH	CS
		POP	ES
		CALL	S_SETB8 		;打开B8 	11.29
		MOV	DI,OFFSET D_XPQ
		MOV	DS,CS:D_B800		;B800区段
		XOR	SI,SI
		MOV	CX,25*80
L_0810:
		CMP	CS:D_0060,2		;高位闪烁?
		JNZ	L_0820
		INC	CS:D_NUM
		CMP	CS:D_NUM,4
		JNZ	L_0820
		MOV	CS:D_NUM,0
		PUSH	CX
		PUSH	SI
L_0812:
		LODSW
		TEST	AH,80H			;高位=1?
		JZ	L_0813
		XOR	AH,0FH			;前景属性异或
		MOV	DS:[SI-2],AX
L_0813:
		LOOP	L_0812
		POP	SI
		POP	CX
L_0820:
		PUSH	SI
		PUSH	DI
		REPE	CMPSW			;比较?
		POP	DI
		POP	SI
		JZ	L_0830
		CALL	S_QGB			;清光标
		CALL	S_XR			;处理直接写屏
L_0830:
		CMP	CS:IN_INT10,0FFH	;在INT10中?
		JZ	L_0840
		CALL	S_GBSS
L_0840:
		AND	CS:D_8,7FH		;3.16
		POP	BP
		POP	DI
		POP	SI
		POP	DX
		POP	CX
		POP	BX
		POP	AX
		POP	ES
		POP	DS
		RET
S_0800		ENDP

